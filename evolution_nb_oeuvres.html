<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>ADONA oeuvres</title>
		<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
		<script src="https://d3js.org/d3-geo.v1.min.js"></script>
		<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
		<script src="js/d3.slider.js"></script><!-- http://github.com/turban/d3.slider -->
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="stylesheet" type="text/css" href="css/d3.slider.css">
	</head>
    <body>
        <div id="map"></div>
        <div id="slider"></div>
        
        <script type="text/javascript">
        
            // width and height of svg
            var w = (window.innerWidth)*9/12;
            var h = 500;
            
            // creating svg element
            var svg = d3.select('#map')
                .append('svg')
                .attr('width', w)
                .attr('height', h);
            
            // map projection    
            var projection = d3.geoRobinson()
                .scale(150);
            var path = d3.geo.path()
                .projection(projection);
                
            // div for tooltips
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                
            // calculate radius of proportional circles
            var calc_radius = function (d) {
            	var rayon = 3 * Math.sqrt(d/Math.PI);
            	return rayon;
            }
            
            // group for countries
            var g1 = svg.append('g');
            
            // group for graticules
            var g2 = svg.append('g');
            
            // group for circles
            var g3 = svg.append('g');
            
            // adding countries from Natural Earth  
            d3.json('data/ne_110m_admin_0_countries.json', function (json) {
            	g1.selectAll('path')
            	   .data(json.features)
            	   .enter()
            	   .append('path')
            	   .attr('d', path)
            	   .attr('class', 'pays')
            	   //.attr('stroke-width', function () {
            	   	//console.log(zoom.scale());
            	   //}) 
            });
            
            // adding graticules
            d3.json('data/graticules.json', function (json) {
            	g2.selectAll('path')
            	   .data(json.features)
            	   .enter()
            	   .append('path')
            	   .attr('d', path)
            	   .attr('class', 'graticules')
            	   //.attr('stroke-width', function () {
            	   	//console.log(zoom.scale());
            	   //}) 
            });
            
            // adding ADONA sites
            d3.json('data/evolution_nb_oeuvres_cumul.json', function (json) {
            	g3.selectAll('circle')
            	   .data(json.features)
            	   .enter()
            	   .append('circle')
            	   .attr('r', 0)
            	   .attr('cx',function(d) { return projection(d.geometry.coordinates)[0]})
            	   .attr('cy',function(d) { return projection(d.geometry.coordinates)[1]})
            	   .attr('class', 'site')
            	   // tooltips with site name and artwork number appear on mouseover
            	   .on('mouseover', function (d) {
            	       div.transition()
                            .duration(200)
                            .style("opacity", .9);
        	       	   div.html(d.properties.nom_site + ' : <br>' + d.properties[d3.select(this).text()] + ' oeuvre(s)' )
                           .style("left",  (d3.event.pageX) + "px")
                           .style("top", (d3.event.pageY - 28) + "px")
                       // circle changes color on mouseover
                       d3.select(this)
                           .style("fill", "yellow");
            	   })
            	   // tooltips disappear on mouseout
            	   .on("mouseout", function(d) {
                       div.transition()
                           .duration(200)
                           .style("opacity", 0)
                       // circle gets its original color back
                       d3.select(this)
                           .style("fill", "orange");
                   });
            });
            
            // creating slider
            d3.select('#slider')
                .call(d3.slider().axis(true).min(1910).max(2020).step(10)
                // if slider value changes
                .on("slide", function (evt, value) {
            	   svg.selectAll("circle")
            	       // set corresponding column name from json as text to retrieve it easily for tooltips
            	       .text('oeuvres_' + (value-10) + '_' + (value-1))
            	       // column name from point geojson looks like this : oeuvre_1910_1919
            	       .transition()
            	       .duration(500)
            	       .attr('r', function(d){
            	           colname = 'oeuvres_' + (value-10) + '_' + (value-1);
            	           return calc_radius(d.properties[colname])
            	       })
                })
            );
            
            zoom = d3.behavior.zoom()
                // min and max zoom
                .scaleExtent([1,40])
                .on("zoom", function () {
                	g1.attr("transform", "translate(" + d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")");
                	g2.attr("transform", "translate(" + d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")");
                	g3.attr("transform", "translate(" + d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")");
                	// rescale contries outline so that it does not get too wide when zooming
                    g1.selectAll("path")
                        .attr("d", path.projection(projection))
                        .attr('stroke-width', 1/(zoom.scale()));
                    // rescale graticules outline so that it does not get too wide when zooming
                    g2.selectAll("path")
                        .attr("d", path.projection(projection))
                        .attr('stroke-width', 1/(zoom.scale()));
                    // rescale circle size so that they don't get too big when zooming
                    g3.selectAll("circle")
                        //.attr("r", function() {console.log(zoom.scale()); return d3.select(this).attr("r")/zoom.scale()});
                        .attr("r", function(d) {return calc_radius(d.properties[colname])/zoom.scale()});
                });
                
            svg
    	       .call(zoom)
               .call(zoom.event);
                    

            
        </script>
    </body>
</html>